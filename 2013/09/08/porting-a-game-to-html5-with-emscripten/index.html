
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Porting a C++ Game from iOS to HTML5 with Emscripten - Nikita Leshenko's Blog</title>
  <meta name="author" content="Nikita Leshenko">

  
  <meta name="description" content="This post is about my experience porting a real C++ game to HTML5 with
Emscripten. It isn&rsquo;t intended to be a general Emscripten tutorial, but &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.leshenko.net/2013/09/08/porting-a-game-to-html5-with-emscripten">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Nikita Leshenko's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43799539-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner">
</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.leshenko.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
  <li><a href="http://wecreatestuff.com" target="_blank">Projects</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
  
    
      <h1 class="entry-title">Porting a C++ Game From iOS to HTML5 With Emscripten</h1>
    
  
    
      <p class="meta">
        








  


<time datetime="2013-09-08T22:46:00+03:00" pubdate data-updated="true">Sep 8<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><em>This post is about my experience porting a real C++ game to HTML5 with
Emscripten. It isn&rsquo;t intended to be a general Emscripten tutorial, but
rather a post about the issues I&rsquo;ve encountered and how I solved them.</em></p>

<p>When I first saw <a href="http://emscripten.org">Emscripten</a> in action I was blown
away and I immediately decided to give it a try. Emscripten is an
LLVM-to-JavaScript compiler, which basically means that we can compile C++
code into JS and run it in the browser with very little effort. After
compiling a few &ldquo;Hello world&rdquo; projects and verifying that they work, I wanted
to try Emscripten on a real-world game. My iOS game
<a href="https://itunes.apple.com/us/app/interlocked/id554072547">Interlocked</a> seemed
like a good candidate &ndash; it was written in C++ with OpenGL ES 2.0. GLES2 works
well with Emscripten because it&rsquo;s can be mapped directly to WebGL calls
without a need for a wrapper.</p>

<p>I assume that you have a bit of experience with Emscripten (i.e. you
downloaded Emscripten and compiled some tests from there to get a feel for
it), and SCons.</p>

<h1>Setting the build system</h1>

<p>The original iOS version didn&rsquo;t have a real &ldquo;build system&rdquo;. It was written in
XCode so I just dragged and dropped files into the project and it somehow
compiled when I hit Command-R. For Emscripten, I had to choose between good
old Makefiles, CMake or SCons. I chose SCons because I really like having the
full power of Python in the build script and I had very positive experience
with SCons in the past.</p>

<p>As of time of publishing, Emscripten offers two tools for SCons. One is
located in <code>/tools/scons</code> and the other is in <code>/scons-tools</code>. The former is a
thin wrapper around <code>emcc</code> and the latter has much more logic and actually
calls LLVM and <code>emscripten.py</code> by itself.  I tried both and the first tool
worked better for me. The latter required more setup and I didn&rsquo;t see the
benefit for using it in my project. (However if I needed more persice code
generation options I would probably use it.)</p>

<p>In order to follow along, please take a looks the how the source tree of
Interlocked is organized:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Source tree of Interlocked
</span><span class='line'>├── Assets
</span><span class='line'>│   └── ...
</span><span class='line'>│
</span><span class='line'>├── GameData
</span><span class='line'>│   └── ...
</span><span class='line'>│
</span><span class='line'>├── Models
</span><span class='line'>│
</span><span class='line'>├── Interlocked
</span><span class='line'>│   └── ... // Platform independent core of the game
</span><span class='line'>│
</span><span class='line'>├── Platforms
</span><span class='line'>│   ├── Android
</span><span class='line'>│   │   └── ... // Android specific stuff
</span><span class='line'>│   ├── iOS
</span><span class='line'>│   │   └── ... // iOS specific stuff
</span><span class='line'>│   └── html5 // Emscripten stuff
</span><span class='line'>│       ├── libs
</span><span class='line'>│       │   ├── libpng
</span><span class='line'>│       │   └── zlib
</span><span class='line'>│       └── platform
</span><span class='line'>│
</span><span class='line'>└── Tools
</span><span class='line'>    └── ...</span></code></pre></td></tr></table></div></figure>


<p>The master SConstruct file went into <code>Platforms/html5</code>. It needed to build the
following components:</p>

<ul>
<li><code>interlocked_core</code> &ndash; all generic Interlocked code that was in
<code>Interlocked/</code>. This code was built into it&rsquo;s own static library.</li>
<li><code>libpng</code> and <code>zlib</code> &ndash; <code>interlocked_core</code> uses them for loading the assets.
They were also built into static libraries from the sources at
<code>Platform/html5/libs</code>.</li>
<li><code>interlocked.html</code> &ndash; the final product was built from the sources at
<code>Platforms/html5/platform</code> which included the platform-specific code to
initialize Interlocked. It was linked against <code>interlocked_core</code>, <code>libpng</code>
and <code>zlib</code>.</li>
</ul>


<p>Here is the base SConstruct script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'>
</span><span class='line'><span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span>
</span><span class='line'>        <span class="n">toolpath</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;EMSCRIPTEN_TOOL_PATH&#39;</span><span class="p">]]</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'><span class="n">env</span><span class="o">.</span><span class="n">Tool</span><span class="p">(</span><span class="s">&#39;emscripten&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">CCFLAGS</span><span class="o">=</span><span class="s">&#39;-Wno-warn-absolute-paths&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">LIBS</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>
</span><span class='line'><span class="n">PLATFORM_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;platform&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">LIBS_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;libs&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">CORE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;../../Interlocked&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">LIBS</span> <span class="o">+=</span> <span class="n">SConscript</span><span class="p">(</span><span class="s">&#39;SConscript_core&#39;</span><span class="p">,</span> <span class="n">src_dir</span><span class="o">=</span><span class="n">CORE_DIR</span><span class="p">,</span> <span class="n">variant_dir</span><span class="o">=</span><span class="s">&#39;build/core&#39;</span><span class="p">,</span> <span class="n">duplicate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span class='line'>        <span class="n">exports</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;env&#39;</span><span class="p">,</span> <span class="s">&#39;CORE_DIR&#39;</span><span class="p">,</span> <span class="s">&#39;PLATFORM_DIR&#39;</span><span class="p">,</span> <span class="s">&#39;LIBS_DIR&#39;</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="n">LIBS</span> <span class="o">+=</span> <span class="n">SConscript</span><span class="p">(</span><span class="s">&#39;libs/libpng/SConscript&#39;</span><span class="p">,</span> <span class="n">variant_dir</span><span class="o">=</span><span class="s">&#39;build/libs/libpng&#39;</span><span class="p">,</span> <span class="n">duplicate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span class='line'>        <span class="n">exports</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;env&#39;</span><span class="p">])</span>
</span><span class='line'><span class="n">LIBS</span> <span class="o">+=</span> <span class="n">SConscript</span><span class="p">(</span><span class="s">&#39;libs/zlib/SConscript&#39;</span><span class="p">,</span> <span class="n">variant_dir</span><span class="o">=</span><span class="s">&#39;build/libs/zlib&#39;</span><span class="p">,</span> <span class="n">duplicate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span class='line'>        <span class="n">exports</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;env&#39;</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="n">SConscript</span><span class="p">(</span><span class="s">&#39;platform/SConscript&#39;</span><span class="p">,</span> <span class="n">variant_dir</span><span class="o">=</span><span class="s">&#39;build/interlocked&#39;</span><span class="p">,</span> <span class="n">duplicate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span class='line'>        <span class="n">exports</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;env&#39;</span><span class="p">,</span> <span class="s">&#39;CORE_DIR&#39;</span><span class="p">,</span> <span class="s">&#39;PLATFORM_DIR&#39;</span><span class="p">,</span> <span class="s">&#39;LIBS&#39;</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Building <code>interloked_core</code></h2>

<p>This one was a bit tricky from SCons perspective.</p>

<ul>
<li>Source tree</li>
<li>emscons</li>
<li>Compile to objects?</li>
</ul>


<h2>TODO</h2>

<ul>
<li>Open AL</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Nikita Leshenko</span></span>

      








  


<time datetime="2013-09-08T22:46:00+03:00" pubdate data-updated="true">Sep 8<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/categories/emscripten/'>emscripten</a>, <a class='category' href='/categories/scons/'>scons</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.leshenko.net/2013/09/08/porting-a-game-to-html5-with-emscripten/" data-via="" data-counturl="http://blog.leshenko.net/2013/09/08/porting-a-game-to-html5-with-emscripten/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2013/09/05/testing-octopress/" title="Previous Post: Testing Octopress">&laquo; Testing Octopress</a>
      
      
        <a class="basic-alignment right" href="/2013/11/16/powerline-segments-not-showing-up-in-tmux/" title="Next Post: Powerline Segments not Showing Up in tmux">Powerline Segments not Showing Up in tmux &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Nikita Leshenko <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>, customized with <a href="https://github.com/mjhea0/whiterspace">whiterspace</a>.</span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
